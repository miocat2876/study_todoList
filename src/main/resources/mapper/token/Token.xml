<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.famback.fam.jwt.mapper.JwtMapper">

<!--    modifyAccessToken-->
    <select id="findRefreshTokenByKey" parameterType="string" resultType="tokenDomain">
        SELECT REFRESH_TOKEN AS refreshToken
             , USER_AGENT    AS userAgent
             , MEMBER_FK     AS memberFk
             , IP            AS ip
          FROM MEMBER_TOKEN_TAB
         WHERE NUM_PK     = #{numPK}
           AND DELETE_YN  = 'N'
    </select>

    <!--  토큰 참조 멤버 키 확인  -->
    <select id="existsByKey" parameterType="tokenDomain" resultType="int">
        SELECT EXISTS (SELECT NUM_PK
                         FROM MEMBER_TOKEN_TAB
                        WHERE MEMBER_FK  = #{memberFk}
                          AND IP         = #{ip}
<!--                          AND USER_AGENT = #{userAgent}-->
                          AND DELETE_YN  = 'N'
                       LIMIT 1
        )
    </select>

    <!-- 엑세스 토큰 유효 확인  -->
    <select id="existsByAccessKey" parameterType="tokenDomain" resultType="int">
        SELECT EXISTS (SELECT NUM_PK
                         FROM MEMBER_TOKEN_TAB
                        WHERE MEMBER_FK    = #{memberFk}
<!--                          AND USER_AGENT   = #{userAgent}-->
                          AND IP           = #{ip}
                          AND DELETE_YN  = 'N'
                        LIMIT 1
                   )
    </select>

    <!-- 토큰 적재  -->
    <insert id="createToken" parameterType="tokenDomain">
        INSERT INTO MEMBER_TOKEN_TAB
        (NUM_PK, CREATE_DATE, DELETE_DATE, DELETE_YN, REFRESH_TOKEN, USER_AGENT, MEMBER_FK, ACCESS_TOKEN, REFRESH_EXPIRATION_TIME, ACCESS_EXPIRATION_TIME, IP)
        VALUES(#{numPk}, current_timestamp(), NULL, 'N', #{refreshToken}, #{userAgent}, #{memberFk}, #{accessToken}, #{refreshExpirationTime}, #{accessExpirationTime}, #{ip})
    </insert>

    <!--  엑세스 토큰 최신화  -->
    <update id="modifyAccessToken" parameterType="tokenDomain">
        UPDATE MEMBER_TOKEN_TAB
           SET UPDATE_DATE = current_timestamp(), ACCESS_TOKEN = #{accessToken},
               ACCESS_EXPIRATION_TIME = #{accessExpirationTime}, USER_AGENT = #{userAgent}
         WHERE NUM_PK = #{numPk}
    </update>

    <!--  토큰 삭제  -->
    <update id="deleteToken" parameterType="tokenDomain">
        UPDATE MEMBER_TOKEN_TAB
           SET DELETE_DATE=current_timestamp(), DELETE_YN='Y'
         WHERE MEMBER_FK    = #{memberFk}
<!--           AND USER_AGENT   = #{userAgent}-->
           AND IP           = #{ip}
           AND DELETE_YN    = 'N'
    </update>

    <!-- 해당 멤버 모든 토큰 삭제  -->
    <update id="deleteMemberAllTokenByKey" parameterType="tokenDomain">
        UPDATE MEMBER_TOKEN_TAB
           SET DELETE_DATE=current_timestamp(), DELETE_YN='Y'
         WHERE MEMBER_FK    = #{memberFk}
           AND DELETE_YN    = 'N'
    </update>

</mapper>