<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.famback.fam.board.mapper.BoardMapper">

	<select id="boardClass" parameterType="boardDomain" resultType="boardDomain">
		SELECT MC.NUM_PK		                                                                               AS numPk
			 , MC.CLASS_NAME	                                                                               AS className
			 , A.NUM_PK			                                                                               AS userFK
			 , A.COUNT                                                                                         AS count
			 , A.CATEGORY_CODE                                                                                 AS categoryCode
			 , (SELECT DESCRIPTION FROM COMMON_CODE_TAB WHERE CODE = A.CATEGORY_CODE AND CODE_GROUP = 'S0001') AS categoryName
			 , A.NICKNAME		                   															   AS nickname
		  FROM MEMBER_CLASS_TAB MC
		  	 , (SELECT MCI.NUM_PK
		  	 		 , MCI.MEMBER_CLASS_FK
					 , MCI.NICKNAME
				  FROM USER_TAB MCI
				 WHERE MCI.MEMBER_FK = #{memberFk}) A
		 WHERE A.MEMBER_CLASS_FK = MC.NUM_PK
		   AND MC.DELETE_YN != 'Y'
	</select>

	<select id="findBoardListByMemberClassKeyToSearchValue" parameterType="boardDomain" resultType="boardDomain">
        SELECT @ROWNUM := @ROWNUM + 1                                                                             AS BNO
             , LIST.NUM_PK                                                                                        AS numPk
             , LIST.CLASS_NAME                                                                                    AS className
             , LIST.TITLE                                                                                         AS title
             , LIST.CREATE_DATE                                                                                   AS createDate
             , LIST.COUNT                                                                                         AS count
             , LIST.CATEGORY_CODE                                                                                 AS categoryCode
             , (SELECT DESCRIPTION FROM COMMON_CODE_TAB WHERE CODE = LIST.CATEGORY_CODE AND CODE_GROUP = 'S0001') AS categoryName
             , LIST.NICKNAME                        														      AS nickname
          FROM (SELECT FB.NUM_PK
                     , MC.CLASS_NAME
                     , FB.TITLE
                     , FB.CREATE_DATE
                     , FB.COUNT
		             , FB.CATEGORY_CODE
                     , MCI.NICKNAME
                  FROM (SELECT NUM_PK
                             , TITLE
                             , CREATE_DATE
                             , COUNT
                             , CATEGORY_CODE
                             , USER_FK
                          FROM BOARD_TAB
                         WHERE DELETE_YN = 'N'
                           AND TITLE     LIKE CONCAT('%',#{searchValue},'%')
                       ) FB
                 INNER JOIN USER_TAB MCI
                    ON MCI.NUM_PK = FB.USER_FK
                 INNER JOIN
		               (SELECT NUM_PK
							 , CLASS_NAME
						  FROM MEMBER_CLASS_TAB
						 WHERE NUM_PK = #{memberClassFk}
					   ) MC
                    ON MC.NUM_PK = MCI.MEMBER_CLASS_FK
		             , (SELECT @ROWNUM := 0) RNO
		         ORDER BY NUM_PK
                ) LIST
         ORDER BY BNO DESC
		LIMIT #{rowStart} , #{defaultViewRow}
	</select>

	<select id="findBoardListCountByMemberClassKeyToSearchValue" parameterType="boardDomain" resultType="int">
		SELECT count(*)
		FROM ((SELECT USER_FK
			     FROM BOARD_TAB
			     WHERE DELETE_YN = 'N'
				   AND TITLE     LIKE CONCAT('%',#{searchValue},'%')
		     ) FB
			     INNER JOIN (
			SELECT NUM_PK
		      FROM USER_TAB
			 WHERE MEMBER_CLASS_FK = #{memberClassFk}) MCI
			    ON MCI.NUM_PK = FB.USER_FK
			)
	</select>

	<select id="findByBoardOne" parameterType="boardDomain" resultType="boardDomain">
		SELECT FB.NUM_PK 		AS numPk
			 , FB.CREATE_DATE	AS createDate
			 , FB.TITLE			AS title
			 , FB.CONTENT		AS content
			 , MCI.NICKNAME 	AS nickName
			 , FB.USER_FK       AS userFk
		     , FB.COUNT         AS count
		  FROM BOARD_TAB FB
         INNER JOIN
		      (SELECT NUM_PK
		            , NICKNAME
			     FROM USER_TAB
		        WHERE MEMBER_CLASS_FK = #{memberClassFk}
			  ) MCI
            ON FB.USER_FK = MCI.NUM_PK
	     WHERE FB.NUM_PK  = #{numPk}
		   AND FB.DELETE_YN = 'N'
	</select>

	<insert id="save" parameterType="boardDomain">
		INSERT INTO BOARD_TAB ( NUM_PK
								  , USER_FK
								  , CREATE_DATE
								  , TITLE
								  , CONTENT )
			 VALUES ( (SELECT IFNULL(MAX(NUM_PK),0) FROM BOARD_TAB BT) + 1
			 		, #{userFk}
			   		, now()
			  		, #{title}
			  		, #{content} )
	</insert>

	<update id="updateBoardCountByKey" parameterType="boardDomain">
		 UPDATE BOARD_TAB
		    SET COUNT = COUNT + 1
		  WHERE NUM_PK = #{numPk}
	</update>

	<update id="updateBoard" parameterType="boardDomain">
		 UPDATE BOARD_TAB
		    SET TITLE = #{title}
		   	  , CONTENT = #{content}
		   	  , UPDATE_DATE = NOW()
		  WHERE NUM_PK = #{numPk}
	</update>

	<update id="deleteBoard" parameterType="boardDomain">
		 UPDATE BOARD_TAB
		   SET DELETE_DATE = NOW()
		   	 , DELETE_YN = 'Y'
		 WHERE NUM_PK = #{numPk}
	</update>
	
</mapper>