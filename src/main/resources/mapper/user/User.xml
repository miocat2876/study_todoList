<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.famback.fam.user.mapper.UserMapper">

    <select id="findByMemberClassFkToMemberFK" parameterType="userDomain" resultType="string">
        SELECT NUM_PK AS numPk
          FROM USER_TAB
         WHERE MEMBER_CLASS_FK = #{memberClassFk}
           AND MEMBER_FK = #{memberFk}
           AND DELETE_YN = 'N'
    </select>

    <select id="findOneByUserKey" parameterType="userDomain" resultType="userDomain">
        SELECT UT.NUM_PK            AS numPk
             , UT.CREATE_DATE       AS createDate
             , UT.MEMBER_CLASS_FK   AS memberClassFk
             , UT.NICKNAME          AS nickname
             , UT.MEMBER_FK         AS memberFk
             , UT.DESCRIPTION       AS description
             , MT.EMAIL             AS email
             , UAT.AUTHORITY_CODE   AS authorityCode
          FROM ((SELECT EMAIL
                      , NUM_PK
                   FROM MEMBER_TAB
                  WHERE DELETE_YN = 'N'
                ) MT
                 INNER JOIN
                (
                 SELECT NUM_PK
                      , CREATE_DATE
                      , MEMBER_CLASS_FK
                      , NICKNAME
                      , MEMBER_FK
                      , DESCRIPTION
                   FROM USER_TAB
                  WHERE NUM_PK = #{numPk}
                    AND DELETE_YN = 'N'
                ) UT
                ON UT.MEMBER_FK = MT.NUM_PK
               )
                   LEFT OUTER JOIN
                (
                 SELECT USER_FK
                      , AUTHORITY_CODE
                   FROM USER_AUTHORITY_TAB
                  WHERE USER_FK = #{numPk}
                    AND AUTHORITY_CODE = 'G0001'
                ) UAT
                     ON UT.NUM_PK = UAT.USER_FK
    </select>

<!--    참가중인 방의 리스트-->
    <select id="findClassByMemberKey" parameterType="userDomain" resultType="userDomain">
        SELECT MEMBER_CLASS_FK  AS memberClassFK
             , CLASS_NAME       AS className
          FROM ((SELECT NUM_PK
                      , MEMBER_CLASS_FK
                   FROM USER_TAB
                  WHERE MEMBER_FK = #{memberFk}
                    AND DELETE_YN = 'N'
                ) UT
                   INNER JOIN
                (
                SELECT CLASS_NAME
                     , NUM_PK
                  FROM MEMBER_CLASS_TAB
                 WHERE DELETE_YN = 'N'
                ) MCT
                    ON UT.MEMBER_CLASS_FK = MCT.NUM_PK
          )
    </select>

    <select id="findUserListByMemberClassKey" parameterType="userDomain" resultType="userDomain">
        SELECT NUM_PK         AS numPk
             , CREATE_DATE    AS createDate
             , NICKNAME       AS nickname
             , DESCRIPTION    AS description
             , AUTHORITY_CODE AS authorityCode
          FROM USER_TAB UT
          LEFT OUTER JOIN
             ( SELECT USER_FK
                    , AUTHORITY_CODE
                 FROM USER_AUTHORITY_TAB
             ) UAT
            ON UT.NUM_PK = UAT.USER_FK
         WHERE MEMBER_CLASS_FK = #{memberClassFk}
           AND DELETE_YN = 'N'
    </select>

    <select id="findUserAuthorityCodeByUserKey" parameterType="userDomain" resultType="string">
      SELECT MTAMT.AUTHORITY_CODE
        FROM ((SELECT NUM_PK
                 FROM USER_TAB UT
                WHERE NUM_PK = #{numPk}
              ) UT
                INNER JOIN USER_AUTHORITY_TAB MTAMT
                   ON UT.NUM_PK = MTAMT.USER_FK
             )
    </select>

    <!-- 방참가  -->
    <insert id="createUser" parameterType="userDomain">
        INSERT INTO USER_TAB
        (NUM_PK, CREATE_DATE, UPDATE_DATE, DELETE_DATE, DELETE_YN, MEMBER_CLASS_FK, NICKNAME, MEMBER_FK, DESCRIPTION)
        VALUES(#{numPk}, current_timestamp(), NULL, NULL, 'N', #{memberClassFk}, #{nickname}, #{memberFk}, #{description});
    </insert>

        <!-- 회원마지막번호   -->
    <select id="findLastUserKey" resultType="string">
        SELECT IFNULL(MAX(NUM_PK),0)
          FROM USER_TAB
    </select>

    <!-- 방참가 인원 리스트   -->
    <select id="findMemberClassInfoList" parameterType="string" resultType="userDomain">
        SELECT MCI.NUM_PK                                                                             AS numPk
             , MCI.CREATE_DATE                                                                        AS createDate
             , MCI.UPDATE_DATE                                                                        AS updateDate
             , MCI.DELETE_DATE                                                                        AS deleteDate
             , MCI.DELETE_YN                                                                          AS deleteYn
             , MCI.MEMBER_CLASS_FK                                                                    AS memberClassFk
             , MCI.NICKNAME                                                                           AS nickname
             , MCI.MEMBER_FK                                                                          AS memberFk
             , MCI.DESCRIPTION                                                                        AS description
             , (SELECT AUTHORITY_NAME  FROM AUTHORITY_TAB WHERE AUTHORITY_CODE  = MAM.AUTHORITY_CODE) AS authorityName
             , MAN.AUTHORITY_CODE                                                                    AS authorityCode
          FROM ((SELECT NUM_PK
                     , CREATE_DATE
                     , UPDATE_DATE
                     , DELETE_DATE
                     , DELETE_YN
                     , MEMBER_CLASS_FK
                     , NICKNAME
                     , MEMBER_FK
                     , DESCRIPTION
                  FROM USER_TAB
                 WHERE MEMBER_CLASS_FK = :memberClassFk
                   AND DELETE_YN = 'N' AS MCI
                 INNER JOIN
                 (
                 SELECT AUTHORITY_CODE
                      , USER_FK
                   FROM USER_AUTHORITY_TAB
                 ) AS MAM
                    ON MCI.NUM_PK = MAM.USER_FK
             )
    </select>

    <!-- 방 참가 회원 수정  -->
    <update id="updateUser" parameterType="memberDomain">
        UPDATE USER_TAB
           SET UPDATE_DATE = current_timestamp(), NICKNAME = #{nickname} , DESCRIPTION = #{description}
         WHERE NUM_PK=#{numPk}
           AND DELETE_YN = 'N'
    </update>

    <!-- 방 참가 회원 삭제  -->
    <update id="deleteUser" parameterType="memberDomain">
        UPDATE USER_TAB
           SET DELETE_DATE = current_timestamp(), DELETE_YN = 'Y'
         WHERE NUM_PK=#{numPk}
    </update>

    <!-- 가입된 멤버키로  방 참가 회원 삭제  -->
    <update id="deleteUserByMemberKey" parameterType="memberDomain">
        UPDATE USER_TAB
           SET DELETE_DATE = current_timestamp(), DELETE_YN = 'Y'
         WHERE NUM_PK IN (SELECT NUM_PK
                            FROM USER_TAB
                           WHERE MEMBER_FK = #{memberFk}
                             AND DELETE_YN = 'N'
                         );
    </update>


</mapper>